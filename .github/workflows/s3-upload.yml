name: Upload testfile to S3 (OIDC)

on:
  push:
    branches: [main]

permissions:
  id-token: write   # needed for OIDC to assume the AWS role
  contents: read    # needed to checkout the code/file

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
  S3_DESTINATION: ${{ vars.S3_UPLOAD_DESTINATION }} # e.g., s3://my-bucket/path/
  FILE_TO_UPLOAD: files.tar.gz

jobs:
  upload:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      
      - name: Validate config (pre-check)
        run: |
          if [ -z "${S3_DESTINATION}" ]; then
            echo "::error::S3 destination not configured."
            exit 1
          fi

      - name: Tar files folder
        run: |
          if [ -d "files" ]; then
            tar -czf "${FILE_TO_UPLOAD}" files
          else
            echo "::error::Directory 'files' not found."
            exit 1
          fi

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_UPLOAD_ROLE_ARN }}
          role-session-name: gh-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}
          mask-aws-account-id: true

      - name: Upload file to S3
        run: |
          DEST="${S3_DESTINATION%/}/"
          aws s3 cp "${FILE_TO_UPLOAD}" "${DEST}"

